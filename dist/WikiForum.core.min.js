/*! For license information please see WikiForum.core.min.js.LICENSE.txt */
!function(){var t={223:function(t,e,r){var n=r(344),o=n.api,a=(n.conf,n.editToken);t.exports=function(t){var e=t.title,r=t.text,n=t.summary;return $.post(o,{format:"json",action:"edit",token:a,title:e,text:r,summary:n})}},946:function(t,e,r){var n=r(344),o=n.api,a=n.conf;t.exports=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:a.wgPageName;return $.get(o,{format:"json",action:"parse",prop:"text|wikitext",page:t})}},416:function(t){function e(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];(t=console).info.apply(t,["[WikiForum] [INFO]"].concat(r))}function r(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];(t=console).error.apply(t,["[WikiForum] [ERR]"].concat(r))}t.exports={log:e,info:e,warn:function(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];(t=console).warn.apply(t,["[WikiForum] [WARN]"].concat(r))},error:r,err:r}},344:function(t){t.exports={api:mw.util.wikiScript("api"),conf:mw.config.get(),editToken:mw.user.tokens.get("csrfToken"),hook:mw.hook,util:mw.util}},904:function(t,e,r){var n=r(416).log;function o(t,e){var r=$(t),o=[];return r.hasClass("wiki-forum")||(r=r.find(".wiki-forum")),n("开始解析全论坛结构"),r.each((function(t,r){n("单论坛结构",{index:t,forum:r}),o.push({forumid:String(t+1),meta:$.extend({},$(r).data(),{pageName:e}),threads:a(r)})})),o}function a(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=$(t);e&&(e+="-");var n=[];return $threads=i(r),$.each($threads,(function(t,r){var o={threadid:String(e+(t+1)),content:c(r),meta:u(r)};i(r).length>0&&(o.threads=a(r,o.threadid)),n.push(o)})),n}function i(t){return $(t).find("> .forum-thread")}function c(t){var e=$(t).find("> .forum-content").html()||"";return e=e.trim().replace(/^<!--\s*?start\s+?content\s*?-->/,"").replace(/<!--\s*?end\s+?content\s*?-->$/,"").replace(/^\n/,"").replace(/\n$/,"")}function u(t){return $(t).data()}t.exports={fromApi:function(t){n("从 API 结果解析论坛结构");var e=t.parse.title,r=t.parse.wikitext["*"],a=t.parse.text["*"],i=$("<div>"+r+"</div>"),c=$("<div>"+a+"</div>");c.find("> .mw-parser-output").length>0&&(c=c.find("> .mw-parser-output"));var u={wikitext:o(i,e),html:o(c,e)};return window.WikiForum=window.WikiForum||{},window.WikiForum.cache=window.WikiForum.cache||{},window.WikiForum.cache.pages=window.WikiForum.cache.pages||{},window.WikiForum.cache.pages[e]=u,n("从 API 结果解析完成",u),u},fromHtml:function(t){var e=$(t),r=o(e);return n("从 HTML 源代码解析完成",r),r}}},767:function(t,e,r){var n=r(904).fromApi,o=r(946),a=r(344),i=(a.util,a.hook),c=a.conf,u=r(416),d=u.log,m=u.error;function f(t){var e=t.forumEl,r=t.forumid,n=void 0===r?"1":r,o=t.threadid;n=Number(n);var a=e[--n];o=o.split("-"),$.each(o,(function(t,e){e=Number(e),e--,o[t]=e}));var i=a;return $.each(o,(function(t,e){d("thread",i.threads[e]),i=i.threads[e]})),i}function h(t){var e=t.Obj,r=t.theme;d("开始渲染全部论坛"),$root=r.allForumsContainer();var n=e.html;return $.each(n,(function(t,o){d("递归渲染主题","".concat(t+1,"/").concat(n.length)),$root.append(function(t){var e=t._forum,r=t.forum,n=t.forumMeta,o=t.forumid,a=t.theme;d("渲染主题",{forumid:o});var i=a.forumContainer({meta:n});$.each(r.threads,(function(t,r){i.append(s({_forum:e,theme:a,thread:r,forumMeta:n,forumid:o}))})),a.afterForum&&i.append(a.afterForum({_forum:e,forumMeta:n,forumid:o,fn:l}));return i}({_forum:e,forumMeta:o.meta,forumid:o.forumid,forum:o,theme:r}),r.afterAllForums?r.afterAllForums():"")})),$root}function s(t){var e=t._forum,r=t.theme,n=t.thread,o=t.forumMeta,a=t.forumid,i=n.content,c=n.meta,u=n.threadid;d("渲染贴子",{forumid:a,threadid:u});var m=r.threadContainer({_forum:e,forumMeta:o,forumid:a,threadid:u,meta:c,content:i,fn:l});return n.threads&&n.threads.length>0&&$.each(n.threads,(function(e,r){t.thread=r,m.append(s(t))})),m}var l={parser:r(904),updater:r(515)};function p(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"#mw-content-text";d("准备渲染到页面，等待主题文件……"),i("WikiForum.theme").fire((function(r){$(e).html(h({Obj:t,theme:r})),d("页面渲染完毕"),i("WikiForum.renderer").fire()}))}t.exports={toPage:p,toHtml:function(t){d("渲染并返回 HTML"),mw.hook("WikiForum.theme").fire((function(e){return h({forumEl:t,theme:e})}))},fromPage:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:c.wgPageName,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"#mw-content-text";d("从页面加载信息并渲染",{page:t,target:e}),o(t).then((function(r){d("成功从 API 获取源代码",t),p(n(r),e)}),(function(e){m("从 API 获取源代码失败",{page:t,err:e})}))},getContent:function(t){return f(t).content},getMeta:function(t){return f(t).meta}}},515:function(t,e,r){var n=r(344).conf,o=r(416),a=o.log,i=o.error,c=r(223);function u(t,e){var o=t[0].meta.pageName,u=function(t){var e="";return $.each(t,(function(t,r){e+=function(t){var e=t.forumid,r=t.meta,n=t.threads,o=m(r),a="";return $.each(n,(function(t,e){a+=d(e)})),"\n\x3c!-- start forum#".concat(e||"latest",' --\x3e\n<div class="wiki-forum" ').concat(o,">\n").concat(a,"\n</div>\n\x3c!-- end forum#").concat(e||"latest"," --\x3e")}(r)})),e="\x3c!--\n - WikiForum Container\n - \n - Total Forums: ".concat(t.length,"\n - Last modiflied: ").concat(f(),"\n - Last user: ").concat(n.wgUserName,"\n -\n - DO NOT EDIT DIRECTLY\n --\x3e\n").concat(e,"\n\n\x3c!-- end WikiForum --\x3e")}(t);c({title:o,text:u,summary:e}).then((function(t){t.error||t.errors?i(t.error||t.errors):(a("更新论坛成功",t),(0,r(767).fromPage)(o))}),(function(t){return i}))}function d(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=t.threadid,n=t.meta,o=t.threads,a=t.content,i=m(n),c="",u=0;u<e;u++)c+="  ";var f="";o&&o.length>0&&$.each(o,(function(t,r){f+=d(r,e+1)}));var h="\n".concat(c,"\x3c!-- start thread#").concat(r||"latest"," --\x3e\n").concat(c,'<div class="forum-thread" ').concat(i,">\n").concat(c,'  <div class="forum-content">\n\x3c!-- start content --\x3e\n').concat(a,"\n\x3c!-- end content --\x3e\n").concat(c,"  </div>").concat(f,"\n").concat(c,"</div>\n").concat(c,"\x3c!-- end thread#").concat(r||"latest"," --\x3e\n");return h}function m(t){var e=[];return $.each(t,(function(t,r){var n="data-"+t.replace(/(.*)([A-Z])(.*)/g,"$1-$2$3").toLowerCase();e.push("".concat(n,'="').concat(r,'"'))})),e=e.join(" ")}function f(){return(new Date).toISOString()}function h(t){var e=t.forumEl,r=t.forumid,o=t.content,i=e.wikitext;r=Number(r),i[--r].threads.push({meta:{userAuthor:n.wgUserName,userLast:n.wgUserName,timePublish:f(),timeModify:f()},content:o}),a("Add thread",{forumid:r,content:o}),u(i,"[WikiForum] Add thread to forum#".concat(r))}function s(t){var e=t.forumEl,r=t.forumid,o=void 0===r?"1":r,i=t.threadid,c=t.content,d=e.wikitext;if("1"===i)return h({forumEl:e,forumid:o,content:c});o=Number(o),function t(e,r){var o=e.threadid,a=e.content,i=r.threads;$.each(i,(function(e,r){r.threadid===o?(r.threads=r.threads||[],r.threads.push({meta:{userAuthor:n.wgUserName,userLast:n.wgUserName,timePublish:f(),timeModify:f()},content:a})):r.threads&&t({threadid:o,content:a},r)}))}({threadid:i,content:c},d[--o]),a("Add reply",{forumid:o,threadid:i,content:c}),u(d,"[WikiForum] Add reply to forum#".concat(o," > thread#").concat(i))}t.exports={addReply:s,newReply:s,addThread:h,newThread:h,updateThread:function(t){var e=t.forumEl,r=t.forumid,o=void 0===r?"1":r,i=t.threadid,c=t.content,d=e.wikitext;o=Number(o),function t(e,r){var o=e.threadid,a=e.content,i=r.threads;$.each(i,(function(e,r){r.threadid===o?(r.content=a,r.meta.userLast=n.wgUserName,r.meta.timeModify=f()):r.threads&&t({threadid:o,content:a},r)}))}({threadid:i,content:c},d[--o]),a("Update thread",{forumid:o,threadid:i,content:c}),u(d,"[WikiForum] Modify forum#".concat(o," > thread#").concat(i))}}}},e={};function r(n){if(e[n])return e[n].exports;var o=e[n]={exports:{}};return t[n](o,o.exports,r),o.exports}!function(){"use strict";var t=r(416),e=r(344).hook;mw.loader.using(["mediawiki.api","mediawiki.util","mediawiki.user"],(function(){var n={parser:r(904),renderer:r(767),updater:r(515)};window.WikiForum=$.extend({},window.WikiForum,n),e("WikiForum").fire(n),t.log("Ready!")}))}()}();
//# sourceMappingURL=WikiForum.core.min.js.map