/*! For license information please see WikiForum.core.min.js.LICENSE.txt */
!function(){var t={946:function(t,r,e){var n=e(344),o=n.api,a=n.conf;t.exports=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:a.wgPageName;return $.get(o,{format:"json",action:"parse",prop:"text|wikitext",page:t})}},416:function(t){function r(){for(var t,r=arguments.length,e=new Array(r),n=0;n<r;n++)e[n]=arguments[n];(t=console).info.apply(t,["[WikiForum] [INFO]"].concat(e))}function e(){for(var t,r=arguments.length,e=new Array(r),n=0;n<r;n++)e[n]=arguments[n];(t=console).error.apply(t,["[WikiForum] [ERR]"].concat(e))}t.exports={log:r,info:r,warn:function(){for(var t,r=arguments.length,e=new Array(r),n=0;n<r;n++)e[n]=arguments[n];(t=console).warn.apply(t,["[WikiForum] [WARN]"].concat(e))},error:e,err:e}},344:function(t){t.exports={api:mw.util.wikiScript("api"),conf:mw.config.get(),editToken:mw.user.tokens.get("editToken"),hook:mw.hook,util:mw.util}},904:function(t){function r(t,r){var n=$(t),o=[];return n.hasClass("wiki-forum")||(n=n.find(".wiki-forum")),n.each((function(t,r){o.push({id:String(t+1),meta:$(r).data(),threads:e(r)})})),o}function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=$(t);r&&(r+="-");var u=[];return $threads=n(i),$.each($threads,(function(t,i){var d={id:String(r+(t+1)),content:o(i),meta:a(i)};n(i).length>0&&(d.threads=e(i,d.id)),u.push(d)})),u}function n(t){return $(t).find("> .forum-thread")}function o(t){return $(t).find("> .forum-content").html()||""}function a(t){return $(t).data()}t.exports={fromApi:function(t){var e=t.parse.title,n=t.parse.wikitext["*"],o=t.parse.text["*"],a=$("<div>"+n+"</div>"),i=$("<div>"+o+"</div>");i.find("> .mw-parser-output").length>0&&(i=i.find("> .mw-parser-output"));var u={wikitext:r(a),html:r(i)};return window.WikiForum=window.WikiForum||{},window.WikiForum.cache=window.WikiForum.cache||{},window.WikiForum.cache.pages=window.WikiForum.cache.pages||{},window.WikiForum.cache.pages[e]=u,u},fromHtml:function(t){return r($(t))}}},767:function(t,r,e){var n=e(904).fromApi,o=e(946),a=e(344).util,i=e(416);function u(t){var r=t.forumEl,e=t.forumid,n=void 0===e?"1":e,o=t.threadid;n=Number(n);var a=r[--n];o=o.split("-"),$.each(o,(function(t,r){r=Number(r),r--,o[t]=r}));var u=a;return $.each(o,(function(t,r){i.log("thread",u.threads[r]),u=u.threads[r]})),u}function d(t){var r=t.forumEl,e=t.theme;return $root=e.allForumsContainer(),$.each(r,(function(t,n){$root.append(f({_forum:r,forumid:n.id,forumEl:n,theme:e}))})),$root}function f(t,r){var e=t._forum,n=t.forumEl,o=t.forumid,a=t.theme,i=n.threads;r=r||$(a.forumContainer({meta:n.meta}));var u=function(t){var r=t.forumEl,e=t.forumid,n=$("<textarea>",{class:"forum-textarea"}),o=$("<button>",{text:"提交",class:"forum-submit-btn"}).click((function(){var t=n.val();t&&newThread({forumEl:r,forumid:e,content:t})}));return $("<div>",{class:"forum-new-thread-area","data-debug":JSON.stringify({forumid:e})}).append($("<label>",{class:"forum-input-container"}).append($("<div>").append(n),$("<div>").append(o)))}({forumEl:e,forumid:e.meta.id});return $.each(i,(function(i,d){var c;if(c=0===i&&n.title?a.firstThread({meta:d.meta,content:d.content,fn:{newThreadArea:u,newReplyArea:m({forumEl:e,forumid:o,threadid:d.id})}}):a.normalThread({meta:d.meta,content:d.content,fn:{newThreadArea:u,newReplyArea:m({forumEl:e,forumid:o,threadid:d.id})}}),d.threads&&d.threads.length>0){var h=t;h.forumEl=d,c.append(f(h,c))}r.append(c)})),r}function m(t){t.forumEl;var r=t.forumid,e=t.threadid,n=$("<a>",{text:"回复",href:"javascript:;"}),o=$("<a>",{text:"编辑",href:"javascript:;"}),a=$("<a>",{text:"删除",href:"javascript:;"}),i=$("<textarea>",{class:"forum-textarea"}),u=$("<button>",{text:"提交",class:"forum-submit-btn"});return $("<div>",{class:"forum-new-reply-area","data-debug":JSON.stringify({forumid:r,threadid:e})}).append($("<div>",{class:"forum-modify-container"}).append(n,o,a),$("<label>",{class:"forum-input-container"}).append($("<div>").append(i),$("<div>").append(u)))}function c(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"#mw-content-text";mw.hook("WikiForum.theme").fire((function(e){$(r).html(d({forumEl:t,theme:e}))}))}t.exports={toPage:c,toHtml:function(t){i.log("renderHTML"),mw.hook("WikiForum.theme").fire((function(r){return d({forumEl:t,theme:r})}))},fromPage:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:a.wgPageName,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"#mw-content-text";i.info("Strat to load page data",t),o(t).then((function(e){i.info("Page data ready",t),c(n(e).html,r)}),(function(t){i.err("Failed to load page data",t)}))},getContent:function(t){return u(t).content},getMeta:function(t){return u(t).meta}}},515:function(t,r,e){var n=e(344).conf;t.exports={addReply:function(t){t.forumEl,t.forumid,t.threadid},addThread:function(t){var r=t.forumEl,e=t.forumid;e=Number(e),e--,(new Date).toISOString(),r[e].threads.push({meta:{}})},updateThread:function(t){var r=t.forumEl,e=t.forumid,o=void 0===e?"1":e,a=t.threadid,i=t.content;o=Number(o);var u=r[--o];return function t(r,e){var o=r.threadid,a=r.content,i=(e=e||u).threads;$.each(i,(function(r,e){e.id===o?(e.content=a,e.meta.userLast=n.wgUserName,e.meta.timeModify=(new Date).toISOString()):e.threads&&t({threadid:o,content:a},e)}))}({threadid:a,content:i}),r}}}},r={};function e(n){if(r[n])return r[n].exports;var o=r[n]={exports:{}};return t[n](o,o.exports,e),o.exports}!function(){"use strict";var t=e(416),r=e(344).hook;mw.loader.using(["mediawiki.api","mediawiki.util","mediawiki.user"],(function(){var n={parser:e(904),renderer:e(767),updater:e(515)};window.WikiForum=$.extend({},window.WikiForum,n),r("WikiForum").fire(n),t.log("Ready!")}))}()}();
//# sourceMappingURL=WikiForum.core.min.js.map