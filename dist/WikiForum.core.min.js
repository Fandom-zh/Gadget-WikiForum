/*! For license information please see WikiForum.core.min.js.LICENSE.txt */
!function(){var t={223:function(t,r,e){var n=e(344),o=n.api,a=(n.conf,n.editToken);t.exports=function(t){var r=t.title,e=t.text,n=t.summary;return $.post(o,{format:"json",action:"edit",token:a,title:r,text:e,summary:n})}},946:function(t,r,e){var n=e(344),o=n.api,a=n.conf;t.exports=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:a.wgPageName;return $.get(o,{format:"json",action:"parse",prop:"text|wikitext",page:t})}},416:function(t){function r(){for(var t,r=arguments.length,e=new Array(r),n=0;n<r;n++)e[n]=arguments[n];(t=console).info.apply(t,["[WikiForum] [INFO]"].concat(e))}function e(){for(var t,r=arguments.length,e=new Array(r),n=0;n<r;n++)e[n]=arguments[n];(t=console).error.apply(t,["[WikiForum] [ERR]"].concat(e))}t.exports={log:r,info:r,warn:function(){for(var t,r=arguments.length,e=new Array(r),n=0;n<r;n++)e[n]=arguments[n];(t=console).warn.apply(t,["[WikiForum] [WARN]"].concat(e))},error:e,err:e}},344:function(t){t.exports={api:mw.util.wikiScript("api"),conf:mw.config.get(),editToken:mw.user.tokens.get("csrfToken"),hook:mw.hook,util:mw.util}},904:function(t,r,e){e(416).log;function n(t,r){var e=$(t),n=[];return e.hasClass("wiki-forum")||(e=e.find(".wiki-forum")),e.each((function(t,e){n.push({forumid:String(t+1),meta:$.extend({},$(e).data(),{pageName:r}),threads:o(e)})})),n}function o(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",e=$(t);r&&(r+="-");var n=[];return $threads=a(e),$.each($threads,(function(t,e){var c={threadid:String(r+(t+1)),content:i(e),meta:u(e)};a(e).length>0&&(c.threads=o(e,c.threadid)),n.push(c)})),n}function a(t){return $(t).find("> .forum-thread")}function i(t){var r=$(t).find("> .forum-content").html()||"";return r=r.trim().replace(/^<!--\s*?start\s+?content\s*?-->/,"").replace(/<!--\s*?end\s+?content\s*?-->$/,"").replace(/^\n/,"").replace(/\n$/,"")}function u(t){return $(t).data()}t.exports={fromApi:function(t){var r=t.parse.title,e=t.parse.wikitext["*"],o=t.parse.text["*"],a=$("<div>"+e+"</div>"),i=$("<div>"+o+"</div>");i.find("> .mw-parser-output").length>0&&(i=i.find("> .mw-parser-output"));var u={wikitext:n(a,r),html:n(i,r)};return window.WikiForum=window.WikiForum||{},window.WikiForum.cache=window.WikiForum.cache||{},window.WikiForum.cache.pages=window.WikiForum.cache.pages||{},window.WikiForum.cache.pages[r]=u,u},fromHtml:function(t){var r=$(t),e=n(r);return e}}},767:function(t,r,e){var n=e(904).fromApi,o=e(946),a=e(344),i=(a.util,a.hook),u=a.conf,c=e(416),m=c.log,d=c.error;function f(t){var r=t.forumEl,e=t.forumid,n=void 0===e?"1":e,o=t.threadid;n=Number(n);var a=r[--n];o=o.split("-"),$.each(o,(function(t,r){r=Number(r),r--,o[t]=r}));var i=a;return $.each(o,(function(t,r){m("thread",i.threads[r]),i=i.threads[r]})),i}function h(t){var r=t.Obj,e=t.theme,n=t.$root;m("开始渲染全部论坛");var o=r.html,a=e.allForumsContainer();return $.each(o,(function(t,i){m("递归渲染主题","".concat(t+1,"/").concat(o.length)),a.append(function(t){var r=t.$root,e=t.$container,n=t._forum,o=t.forum,a=t.forumMeta,i=t.forumid,u=t.theme,c=u.forumContainer({meta:a});$.each(o.threads,(function(t,e){c.append(s({$root:r,$container:c,_forum:n,theme:u,thread:e,forumMeta:a,forumid:i}))})),u.afterForum&&c.append(u.afterForum({$root:r,$container:e,_forum:n,forumMeta:a,forumid:i,fn:l}));return c}({$root:n,_forum:r,forumMeta:i.meta,forumid:i.forumid,forum:i,theme:e}),e.afterAllForums?e.afterAllForums({$root:n,$container:a,_forum:r,forumMeta:i.meta,forumid:i.forumid,fn:l}):"")})),a}function s(t){var r=t.$root,e=t.$container,n=t._forum,o=t.theme,a=t.thread,i=t.forumMeta,u=t.forumid,c=a.content,d=a.meta,f=a.threadid;m("渲染贴子",{forumid:u,threadid:f});var h=o.threadContainer({$root:r,$container:e,_forum:n,forumMeta:i,forumid:u,threadid:f,meta:d,content:c,fn:l});return a.threads&&a.threads.length>0&&$.each(a.threads,(function(r,e){t.thread=e,h.append(s(t))})),h}var l={parser:e(904),updater:e(515)};function p(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"#mw-content-text";m("准备渲染到页面，等待主题文件……"),i("WikiForum.theme").fire((function(e){var n=$(r);n.html(h({Obj:t,theme:e,$root:n})),m("页面渲染完毕"),i("WikiForum.renderer").fire()}))}t.exports={toPage:p,toHtml:function(t){m("渲染并返回 HTML"),mw.hook("WikiForum.theme").fire((function(r){return h({forumEl:t,theme:r})}))},fromPage:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:u.wgPageName,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"#mw-content-text";o(t).then((function(e){m("成功从 API 获取源代码",t),p(n(e),r)}),(function(r){d("从 API 获取源代码失败",{page:t,err:r})}))},getContent:function(t){return f(t).content},getMeta:function(t){return f(t).meta}}},515:function(t,r,e){var n=e(344).conf,o=e(416),a=o.log,i=o.error,u=e(223);function c(t){var r=t.match(/\{\|/g);r=r?r.length:0;var e=t.match(/\n\|\}/g);e=e?e.length:0;for(var n=0;n<r-e;n++)t+="\n|}";var o=document.createElement("container");return o.innerHTML=t,t=o.innerHTML}function m(t){var r=t.$root,o=t.forumEl,c=t.summary,m=o[0].meta.pageName,s=function(t){var r="";return $.each(t,(function(t,e){r+=function(t){var r=t.forumid,e=t.meta,n=t.threads,o=f(e),a="";return $.each(n,(function(t,r){a+=d(r)})),"\n\x3c!-- start forum#".concat(r||"latest",' --\x3e\n<div class="wiki-forum" ').concat(o,">\n").concat(a,"\n</div>\n\x3c!-- end forum#").concat(r||"latest"," --\x3e")}(e)})),r="\x3c!--\n - WikiForum Container\n - \n - Total Forums: ".concat(t.length,"\n - Last modiflied: ").concat(h(),"\n - Last user: ").concat(n.wgUserName,"\n -\n - DO NOT EDIT DIRECTLY\n --\x3e\n").concat(r,"\n\n\x3c!-- end WikiForum --\x3e")}(o);u({title:m,text:s,summary:c}).then((function(t){t.error||t.errors?i(t.error||t.errors):(a("更新论坛成功",t),(0,e(767).fromPage)(m,r))}),(function(t){return i(t)}))}function d(t){for(var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,e=t.threadid,n=t.meta,o=t.threads,a=t.content,i=f(n),u="",m=0;m<r;m++)u+="  ";var h="";o&&o.length>0&&$.each(o,(function(t,e){h+=d(e,r+1)}));var s="\n".concat(u,"\x3c!-- start thread#").concat(e||"latest"," --\x3e\n").concat(u,'<div class="forum-thread" ').concat(i,">\n").concat(u,'  <div class="forum-content">\n\x3c!-- start content --\x3e\n').concat(c(a),"\n\x3c!-- end content --\x3e\n").concat(u,"  </div>").concat(h,"\n").concat(u,"</div>\n").concat(u,"\x3c!-- end thread#").concat(e||"latest"," --\x3e\n");return s}function f(t){var r=[];return $.each(t,(function(t,e){var n="data-"+t.replace(/(.*)([A-Z])(.*)/g,"$1-$2$3").toLowerCase();r.push("".concat(n,'="').concat(e,'"'))})),r=r.join(" ")}function h(){return(new Date).toISOString()}function s(t){var r=t.forumEl,e=t.forumid,o=t.content,i=t.$root,u=r.wikitext;e=Number(e),u[--e].threads.push({meta:{userAuthor:n.wgUserName,userLast:n.wgUserName,timePublish:h(),timeModify:h()},content:o}),a("Add thread",{forumid:e,content:o}),m({$root:i,forumEl:u,summary:"[WikiForum] Add thread to forum#".concat(e)})}function l(t){var r=t.forumEl,e=t.forumid,o=void 0===e?"1":e,i=t.threadid,u=t.content,c=t.$root,d=r.wikitext;if("1"===i)return s({forumEl:r,forumid:o,content:u});o=Number(o),function t(r,e){var o=r.threadid,a=r.content,i=e.threads;$.each(i,(function(r,e){e.threadid===o?(e.threads=e.threads||[],e.threads.push({meta:{userAuthor:n.wgUserName,userLast:n.wgUserName,timePublish:h(),timeModify:h()},content:a})):e.threads&&t({threadid:o,content:a},e)}))}({threadid:i,content:u},d[--o]),a("Add reply",{forumid:o,threadid:i,content:u}),m({$root:c,forumEl:d,summary:"[WikiForum] Add reply to forum#".concat(o," > thread#").concat(i)})}t.exports={addReply:l,newReply:l,addThread:s,newThread:s,updateThread:function(t){var r=t.forumEl,e=t.forumid,o=void 0===e?"1":e,i=t.threadid,u=t.content,c=t.meta,d=void 0===c?{}:c,f=t.$root,s=r.wikitext;o=Number(o),function t(r,e){var o=r.threadid,a=r.content,i=r.meta,u=void 0===i?{}:i,c=e.threads;$.each(c,(function(r,e){e.threadid===o?(a&&(e.content=a,e.meta.userLast=n.wgUserName,e.meta.timeModify=h()),u&&(e.meta=$.extend({},e.meta,u))):e.threads&&t({threadid:o,content:a},e)}))}({threadid:i,meta:d,content:u},s[--o]),a("Update thread",{forumid:o,threadid:i,content:u}),m({$root:f,forumEl:s,summary:"[WikiForum] Modify forum#".concat(o," > thread#").concat(i)})}}}},r={};function e(n){if(r[n])return r[n].exports;var o=r[n]={exports:{}};return t[n](o,o.exports,e),o.exports}!function(){"use strict";var t=e(416),r=e(344).hook;mw.loader.using(["mediawiki.api","mediawiki.util","mediawiki.user"],(function(){var n={parser:e(904),renderer:e(767),updater:e(515)};window.WikiForum=$.extend({},window.WikiForum,n),r("WikiForum").fire(n),t.log("Ready!")}))}()}();
//# sourceMappingURL=WikiForum.core.min.js.map