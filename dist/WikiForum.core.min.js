/*! For license information please see WikiForum.core.min.js.LICENSE.txt */
!function(){var t={946:function(t,r,e){var n=e(344),o=n.api,i=n.conf;t.exports=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:i.wgPageName;return $.get(o,{format:"json",action:"parse",prop:"text|wikitext",page:t})}},416:function(t){function r(){for(var t,r=arguments.length,e=new Array(r),n=0;n<r;n++)e[n]=arguments[n];(t=console).info.apply(t,["[WikiForum] [INFO]"].concat(e))}function e(){for(var t,r=arguments.length,e=new Array(r),n=0;n<r;n++)e[n]=arguments[n];(t=console).error.apply(t,["[WikiForum] [ERR]"].concat(e))}t.exports={log:r,info:r,warn:function(){for(var t,r=arguments.length,e=new Array(r),n=0;n<r;n++)e[n]=arguments[n];(t=console).warn.apply(t,["[WikiForum] [WARN]"].concat(e))},error:e,err:e}},344:function(t){t.exports={api:mw.util.wikiScript("api"),conf:mw.config.get(),editToken:mw.user.tokens.get("editToken"),hook:mw.hook,util:mw.util}},904:function(t,r,e){var n=e(416).log;function o(t,r){var e=$(t),o=[];return e.hasClass("wiki-forum")||(e=e.find(".wiki-forum")),n("开始解析全论坛结构"),e.each((function(t,e){n("单论坛结构",{index:t,forum:e}),o.push({id:String(t+1),title:r,meta:$(e).data(),threads:i(e)})})),o}function i(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",e=$(t);r&&(r+="-");var n=[];return $threads=a(e),$.each($threads,(function(t,e){var o={id:String(r+(t+1)),content:u(e),meta:f(e)};a(e).length>0&&(o.threads=i(e,o.id)),n.push(o)})),n}function a(t){return $(t).find("> .forum-thread")}function u(t){return $(t).find("> .forum-content").html()||""}function f(t){return $(t).data()}t.exports={fromApi:function(t){n("从 API 结果解析论坛结构");var r=t.parse.title,e=t.parse.wikitext["*"],i=t.parse.text["*"],a=$("<div>"+e+"</div>"),u=$("<div>"+i+"</div>");u.find("> .mw-parser-output").length>0&&(u=u.find("> .mw-parser-output"));var f={wikitext:o(a,r),html:o(u,r)};return window.WikiForum=window.WikiForum||{},window.WikiForum.cache=window.WikiForum.cache||{},window.WikiForum.cache.pages=window.WikiForum.cache.pages||{},window.WikiForum.cache.pages[r]=f,n("从 API 结果解析完成",f),f},fromHtml:function(t){var r=o($(t));return n("从 HTML 源代码解析完成",r),r}}},767:function(t,r,e){var n=e(904).fromApi,o=e(946),i=e(344),a=(i.util,i.hook),u=i.conf,f=e(416),m=f.log,d=f.error;function c(t){var r=t.forumEl,e=t.forumid,n=void 0===e?"1":e,o=t.threadid;n=Number(n);var i=r[--n];o=o.split("-"),$.each(o,(function(t,r){r=Number(r),r--,o[t]=r}));var a=i;return $.each(o,(function(t,r){m("thread",a.threads[r]),a=a.threads[r]})),a}function h(t){var r=t.forumEl,e=t.theme;return m("开始渲染全部论坛"),$root=e.allForumsContainer(),$.each(r,(function(t,n){m("递归渲染主题","".concat(t+1,"/").concat(r.length)),$root.append(function(t){var r=t.theme,e=p(t,e);return r.afterForum&&e.append(r.afterForum()),e}({_forum:r,forumMeta:n.meta,forumid:n.id,forumEl:n,theme:e}),e.afterAllForums?e.afterAllForums():"")})),$root}function p(t,r){var e=t._forum,n=t.forumMeta,o=t.threads,i=t.forumid,a=t.theme;return r=a.forumContainer({meta:forumEl.meta}),$.each(o,(function(o,u){m("递归渲染贴子",{forumid:i,threadid:u.id}),$thread=a.threadContainer({_forum:e,forumMeta:n,forumid:i,id:u.id,meta:u.meta,content:u.content,fn:s}),u.threads&&u.threads.length>0&&(t.forumEl=u,$thread.append(p(t,$thread))),r.append($thread)})),r}var s={parser:e(904),updater:e(515)};function l(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"#mw-content-text";m("准备渲染到页面"),a("WikiForum.theme").fire((function(e){$(r).html(h({forumEl:t,theme:e})),m("页面渲染完毕"),a("WikiForum.renderer").fire()}))}t.exports={toPage:l,toHtml:function(t){m("渲染并返回 HTML"),mw.hook("WikiForum.theme").fire((function(r){return h({forumEl:t,theme:r})}))},fromPage:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:u.wgPageName,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"#mw-content-text";m("从页面加载信息并渲染",{page:t,target:r}),o(t).then((function(e){m("成功从 API 获取源代码",t),l(n(e).html,r)}),(function(r){d("从 API 获取源代码失败",{page:t,err:r})}))},getContent:function(t){return c(t).content},getMeta:function(t){return c(t).meta}}},515:function(t,r,e){var n=e(344).conf;t.exports={addReply:function(t){t.forumEl,t.forumid,t.threadid},addThread:function(t){var r=t.forumEl,e=t.forumid;e=Number(e),e--,(new Date).toISOString(),r[e].threads.push({meta:{}})},updateThread:function(t){var r=t.forumEl,e=t.forumid,o=void 0===e?"1":e,i=t.threadid,a=t.content;o=Number(o);var u=r[--o];return function t(r,e){var o=r.threadid,i=r.content,a=(e=e||u).threads;$.each(a,(function(r,e){e.id===o?(e.content=i,e.meta.userLast=n.wgUserName,e.meta.timeModify=(new Date).toISOString()):e.threads&&t({threadid:o,content:i},e)}))}({threadid:i,content:a}),r}}}},r={};function e(n){if(r[n])return r[n].exports;var o=r[n]={exports:{}};return t[n](o,o.exports,e),o.exports}!function(){"use strict";var t=e(416),r=e(344).hook;mw.loader.using(["mediawiki.api","mediawiki.util","mediawiki.user"],(function(){var n={parser:e(904),renderer:e(767),updater:e(515)};window.WikiForum=$.extend({},window.WikiForum,n),r("WikiForum").fire(n),t.log("Ready!")}))}()}();
//# sourceMappingURL=WikiForum.core.min.js.map