/*! For license information please see WikiForum.core.min.js.LICENSE.txt */
!function(){var t={946:function(t,e,r){var n=r(344),o=n.api,i=n.conf;t.exports=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:i.wgPageName;return $.get(o,{format:"json",action:"parse",prop:"text|wikitext",page:t})}},416:function(t){function e(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];(t=console).info.apply(t,["[WikiForum] [INFO]"].concat(r))}function r(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];(t=console).error.apply(t,["[WikiForum] [ERR]"].concat(r))}t.exports={log:e,info:e,warn:function(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];(t=console).warn.apply(t,["[WikiForum] [WARN]"].concat(r))},error:r,err:r}},344:function(t){t.exports={api:mw.util.wikiScript("api"),conf:mw.config.get(),editToken:mw.user.tokens.get("editToken"),hook:mw.hook,util:mw.util}},904:function(t,e,r){var n=r(416).log;function o(t,e){var r=$(t),o=[];return r.hasClass("wiki-forum")||(r=r.find(".wiki-forum")),n("开始解析全论坛结构"),r.each((function(t,r){n("单论坛结构",{index:t,forum:r}),o.push({forumid:String(t+1),meta:$.extend({},$(r).data(),{pageName:e}),threads:i(r)})})),o}function i(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=$(t);e&&(e+="-");var n=[];return $threads=a(r),$.each($threads,(function(t,r){var o={threadid:String(e+(t+1)),content:u(r),meta:d(r)};a(r).length>0&&(o.threads=i(r,o.threadid)),n.push(o)})),n}function a(t){return $(t).find("> .forum-thread")}function u(t){return $(t).find("> .forum-content").html()||""}function d(t){return $(t).data()}t.exports={fromApi:function(t){n("从 API 结果解析论坛结构");var e=t.parse.title,r=t.parse.wikitext["*"],i=t.parse.text["*"],a=$("<div>"+r+"</div>"),u=$("<div>"+i+"</div>");u.find("> .mw-parser-output").length>0&&(u=u.find("> .mw-parser-output"));var d={wikitext:o(a,e),html:o(u,e)};return window.WikiForum=window.WikiForum||{},window.WikiForum.cache=window.WikiForum.cache||{},window.WikiForum.cache.pages=window.WikiForum.cache.pages||{},window.WikiForum.cache.pages[e]=d,n("从 API 结果解析完成",d),d},fromHtml:function(t){var e=$(t),r=o(e);return n("从 HTML 源代码解析完成",r),r}}},767:function(t,e,r){var n=r(904).fromApi,o=r(946),i=r(344),a=(i.util,i.hook),u=i.conf,d=r(416),m=d.log,f=d.error;function c(t){var e=t.forumEl,r=t.forumid,n=void 0===r?"1":r,o=t.threadid;n=Number(n);var i=e[--n];o=o.split("-"),$.each(o,(function(t,e){e=Number(e),e--,o[t]=e}));var a=i;return $.each(o,(function(t,e){m("thread",a.threads[e]),a=a.threads[e]})),a}function h(t){var e=t.Obj,r=t.theme;m("开始渲染全部论坛"),$root=r.allForumsContainer();var n=e.html;return $.each(n,(function(t,o){m("递归渲染主题","".concat(t+1,"/").concat(n.length)),$root.append(function(t){var e=t._forum,r=t.forum,n=t.forumMeta,o=t.forumid,i=t.theme;m("渲染主题",{forumid:o});var a=i.forumContainer({meta:n});$.each(r.threads,(function(t,r){a.append(s({_forum:e,theme:i,thread:r,forumMeta:n,forumid:o}))})),i.afterForum&&a.append(i.afterForum({_forum:e,forumMeta:n,forumid:o,fn:p}));return a}({_forum:e,forumMeta:o.meta,forumid:o.forumid,forum:o,theme:r}),r.afterAllForums?r.afterAllForums():"")})),$root}function s(t){var e=t._forum,r=t.theme,n=t.thread,o=t.forumMeta,i=t.forumid,a=n.content,u=n.meta,d=n.threadid;m("渲染贴子",{forumid:i,threadid:d});var f=r.threadContainer({_forum:e,forumMeta:o,forumid:i,threadid:d,meta:u,content:a,fn:p});return n.threads&&n.threads.length>0&&$.each(n.threads,(function(e,r){t.thread=r,f.append(s(t))})),f}var p={parser:r(904),updater:r(515)};function l(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"#mw-content-text";m("准备渲染到页面，等待主题文件……"),a("WikiForum.theme").fire((function(r){$(e).html(h({Obj:t,theme:r})),m("页面渲染完毕"),a("WikiForum.renderer").fire()}))}t.exports={toPage:l,toHtml:function(t){m("渲染并返回 HTML"),mw.hook("WikiForum.theme").fire((function(e){return h({forumEl:t,theme:e})}))},fromPage:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:u.wgPageName,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"#mw-content-text";m("从页面加载信息并渲染",{page:t,target:e}),o(t).then((function(r){m("成功从 API 获取源代码",t),l(n(r),e)}),(function(e){f("从 API 获取源代码失败",{page:t,err:e})}))},getContent:function(t){return c(t).content},getMeta:function(t){return c(t).meta}}},515:function(t,e,r){var n=r(344).conf,o=r(416).log;function i(){return(new Date).toISOString()}function a(t){var e=t.forumEl,r=t.forumid,a=t.content,u=e.wikitext;r=Number(r),u[--r].threads.push({meta:{userAuthor:n.wgUserName,userLast:n.wgUserName,timePublish:i(),timeModify:i()},content:a}),o("Add thread",{forumid:r,content:a}),d(u)}function u(t){var e=t.forumEl,r=t.forumid,u=void 0===r?"1":r,m=t.threadid,f=t.content,c=e.wikitext;if("1"===m)return a({forumEl:e,forumid:u,content:f});u=Number(u),function t(e,r){var o=e.threadid,a=e.content,u=r.threads;$.each(u,(function(e,r){r.threadid===o?(r.threads=r.threads||[],r.threads.push({meta:{userAuthor:n.wgUserName,userLast:n.wgUserName,timePublish:i(),timeModify:i()},content:a})):r.threads&&t({threadid:o,content:a},r)}))}({threadid:m,content:f},c[--u]),o("Add reply",{forumid:u,threadid:m,content:f}),d(c)}function d(t){o("Make edit",t,{pageName:t[0].meta.pageName,forumsNum:t.length})}t.exports={addReply:u,newReply:u,addThread:a,newThread:a,updateThread:function(t){var e=t.forumEl,r=t.forumid,a=void 0===r?"1":r,u=t.threadid,m=t.content,f=e.wikitext;a=Number(a),function t(e,r){var o=e.threadid,a=e.content,u=r.threads;$.each(u,(function(e,r){r.threadid===o?(r.content=a,r.meta.userLast=n.wgUserName,r.meta.timeModify=i()):r.threads&&t({threadid:o,content:a},r)}))}({threadid:u,content:m},f[--a]),o("Update thread",{forumid:a,threadid:u,content:m}),d(f)}}}},e={};function r(n){if(e[n])return e[n].exports;var o=e[n]={exports:{}};return t[n](o,o.exports,r),o.exports}!function(){"use strict";var t=r(416),e=r(344).hook;mw.loader.using(["mediawiki.api","mediawiki.util","mediawiki.user"],(function(){var n={parser:r(904),renderer:r(767),updater:r(515)};window.WikiForum=$.extend({},window.WikiForum,n),e("WikiForum").fire(n),t.log("Ready!")}))}()}();
//# sourceMappingURL=WikiForum.core.min.js.map