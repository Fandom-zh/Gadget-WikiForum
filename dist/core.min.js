/*! For license information please see core.min.js.LICENSE.txt */
!function(){var t={486:function(t,r,e){var n=e(601),o=n.api,a=n.editToken;t.exports=function(t){var r=t.title,e=t.text,n=t.summary;return $.post(o,{format:"json",action:"edit",token:a,title:r,text:e,summary:n})}},406:function(t,r,e){var n=e(601),o=n.api,a=n.conf;t.exports=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:a.wgPageName;return $.get(o,{format:"json",action:"parse",prop:"text|wikitext",disabletoc:1,disableeditsection:1,page:t})}},853:function(t){function r(){for(var t,r=arguments.length,e=new Array(r),n=0;n<r;n++)e[n]=arguments[n];(t=console).info.apply(t,["[WikiForum] [INFO]"].concat(e))}function e(){for(var t,r=arguments.length,e=new Array(r),n=0;n<r;n++)e[n]=arguments[n];(t=console).error.apply(t,["[WikiForum] [ERR]"].concat(e))}t.exports={log:r,info:r,warn:function(){for(var t,r=arguments.length,e=new Array(r),n=0;n<r;n++)e[n]=arguments[n];(t=console).warn.apply(t,["[WikiForum] [WARN]"].concat(e))},error:e,err:e}},601:function(t){t.exports={api:mw.util.wikiScript("api"),conf:mw.config.get(),editToken:mw.user.tokens.get("csrfToken")||mw.user.tokens.get("editToken"),hook:mw.hook,util:mw.util}},358:function(t){function r(t,r){var n=$(t),o=[];return n.hasClass("wiki-forum")||(n=n.find(".wiki-forum")),n.each((function(t,n){o.push({forumid:String(t+1),meta:$.extend({},$(n).data(),{pageName:r}),threads:e(n)})})),o}function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=$(t);r&&(r+="-");var u=[],c=n(i);return $.each(c,(function(t,i){var c={threadid:String(r+(t+1)),content:o(i),meta:a(i)};n(i).length>0&&(c.threads=e(i,c.threadid)),u.push(c)})),u}function n(t){return $(t).find("> .forum-thread")}function o(t){var r=$(t).find("> .forum-content").html()||"";return r=r.trim().replace(/^<!--\s*?start\s+?content\s*?-->/,"").replace(/<!--\s*?end\s+?content\s*?-->$/,"").replace(/^\n/,"").replace(/\n$/,"")}function a(t){return $(t).data()}t.exports={fromApi:function(t){var e=t.parse.title,n=t.parse.wikitext["*"],o=t.parse.text["*"],a=$("<div>"+n+"</div>"),i=$("<div>"+o+"</div>");i.find("> .mw-parser-output").length>0&&(i=i.find("> .mw-parser-output"));var u={wikitext:r(a,e),html:r(i,e)};return window.WikiForum=window.WikiForum||{},window.WikiForum.cache=window.WikiForum.cache||{},window.WikiForum.cache.pages=window.WikiForum.cache.pages||{},window.WikiForum.cache.pages[e]=u,u},fromHtml:function(t){return r($(t))}}},782:function(t,r,e){var n=e(358).fromApi,o=e(406),a=e(601),i=a.hook,u=a.conf,c=e(853),m=c.log,f=c.error;function d(t){var r=t.forumEl,e=t.forumid,n=void 0===e?"1":e,o=t.threadid;n=Number(n);var a=r[--n];o=o.split("-"),$.each(o,(function(t,r){r=Number(r),r--,o[t]=r}));var i=a;return $.each(o,(function(t,r){m("thread",i.threads[r]),i=i.threads[r]})),i}function s(t){var r=t.forumEl,e=t.theme,n=t.$root;m("开始渲染全部论坛");var o=r.html,a=e.allForumsContainer();return o.length<1?e.noForumContainer&&a.append(e.noForumContainer()):$.each(o,(function(t,i){m("递归渲染主题","".concat(t+1,"/").concat(o.length)),a.append(function(t){var r=t.$root,e=t.$container,n=t._forum,o=t.forum,a=t.forumMeta,i=t.forumid,u=t.theme,c=u.forumContainer({meta:a});$.each(o.threads,(function(t,e){c.append(h({$root:r,$container:c,_forum:n,theme:u,thread:e,forumMeta:a,forumid:i}))})),u.afterForum&&c.append(u.afterForum({$root:r,$container:e,_forum:n,forumMeta:a,forumid:i,fn:l}));return c}({$root:n,_forum:r,forumMeta:i.meta,forumid:i.forumid,forum:i,theme:e}),e.afterAllForums?e.afterAllForums({$root:n,$container:a,_forum:r,forumMeta:i.meta,forumid:i.forumid,fn:l}):"")})),a}function h(t){var r=t.$root,e=t.$container,n=t._forum,o=t.theme,a=t.thread,i=t.forumMeta,u=t.forumid,c=a.content,f=a.meta,d=a.threadid;m("渲染贴子",{forumid:u,threadid:d});var s=o.threadContainer({$root:r,$container:e,_forum:n,forumMeta:i,forumid:u,threadid:d,meta:f,content:c,fn:l});return a.threads&&a.threads.length>0&&$.each(a.threads,(function(r,e){t.thread=e,s.append(h(t))})),s}var l={parser:e(358),updater:e(472)};function p(t){var r=t.forumEl,e=t.target,n=void 0===e?"#mw-content-text":e;m("准备渲染到页面，等待主题文件……"),i("WikiForum.theme").fire((function(t){var e=$(n);e.html(s({forumEl:r,theme:t,$root:e})),m("页面渲染完毕"),i("WikiForum.renderer").fire()}))}t.exports={toPage:p,toHtml:function(t){m("渲染并返回 HTML"),mw.hook("WikiForum.theme").fire((function(r){return s({forumEl:t,theme:r})}))},fromPage:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:u.wgPageName;o(t).then((function(r){m("成功从 API 获取源代码",t),p(n(r))}),(function(r){f("从 API 获取源代码失败",{page:t,err:r})}))},getContent:function(t){return d(t).content},getMeta:function(t){return d(t).meta}}},472:function(t,r,e){function n(t,r){var e="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!e){if(Array.isArray(t)||(e=function(t,r){if(!t)return;if("string"==typeof t)return o(t,r);var e=Object.prototype.toString.call(t).slice(8,-1);"Object"===e&&t.constructor&&(e=t.constructor.name);if("Map"===e||"Set"===e)return Array.from(t);if("Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return o(t,r)}(t))||r&&t&&"number"==typeof t.length){e&&(t=e);var n=0,a=function(){};return{s:a,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,u=!0,c=!1;return{s:function(){e=e.call(t)},n:function(){var t=e.next();return u=t.done,t},e:function(t){c=!0,i=t},f:function(){try{u||null==e.return||e.return()}finally{if(c)throw i}}}}function o(t,r){(null==r||r>t.length)&&(r=t.length);for(var e=0,n=new Array(r);e<r;e++)n[e]=t[e];return n}var a=e(601).conf,i=e(853),u=i.log,c=i.error,m=e(486);function f(t){for(var r=(t.match(/\{\|/g)||[]).length,e=(t.match(/\n\|\}/g)||[]).length,n=0;n<r-e;n++)t+="\n|}";var o=document.createElement("container");return o.innerHTML=t,t=o.innerHTML}function d(t){var r=t.$root,n=t.forumEl,o=t.summary,i=n[0].meta.pageName,f=function(t){var r="";return $.each(t,(function(t,e){r+=function(t){var r=t.forumid,e=t.meta,n=t.threads,o=h(e),a="";return $.each(n,(function(t,r){a+=s(r)})),"\n\x3c!-- start forum#".concat(r||"latest",' --\x3e\n<div class="wiki-forum" ').concat(o,">\n").concat(a,"\n</div>\n\x3c!-- end forum#").concat(r||"latest"," --\x3e")}(e)})),r="\x3c!--\n - WikiForum Container\n - \n - Total Forums: ".concat(t.length,"\n - Last modiflied: ").concat(l(),"\n - Last user: ").concat(a.wgUserName,"\n -\n - DO NOT EDIT DIRECTLY\n --\x3e\n").concat(r,"\n\n\x3c!-- end WikiForum --\x3e")}(n);m({title:i,text:f,summary:o}).then((function(t){t.error||t.errors?c(t.error||t.errors):(u("更新论坛成功",t),(0,e(782).fromPage)(i,r))}),(function(t){return c(t)}))}function s(t){for(var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,e=t.threadid,n=t.meta,o=t.threads,a=t.content,i=h(n),u="",c=0;c<r;c++)u+="  ";var m="";o&&o.length>0&&$.each(o,(function(t,e){m+=s(e,r+1)}));var d="\n".concat(u,"\x3c!-- start thread#").concat(e||"latest"," --\x3e\n").concat(u,'<ul class="forum-thread" ').concat(i,">\n").concat(u,'  <li class="forum-content">\n\x3c!-- start content --\x3e\n').concat(f(a),"\n\x3c!-- end content --\x3e\n").concat(u,"  </li>").concat(m,"\n").concat(u,"</ul>\n").concat(u,"\x3c!-- end thread#").concat(e||"latest"," --\x3e\n");return d}function h(t){var r=[];$.each(t,(function(t,e){var n="data-"+t.replace(/(.*)([A-Z])(.*)/g,"$1-$2$3").toLowerCase();r.push("".concat(n,'="').concat(e,'"'))}));var e,o={},a=n(Object.keys(t).sort());try{for(a.s();!(e=a.n()).done;){var i=e.value;o[i]=r[i]}}catch(t){a.e(t)}finally{a.f()}return r=(r=o).join(" ")}function l(){return(new Date).toISOString()}function p(t){var r=t.forumEl,e=t.forumid,n=t.content,o=t.$root,i=r.wikitext;e=Number(e),i[--e].threads.push({meta:{userAuthor:a.wgUserName,userLast:a.wgUserName,timePublish:l(),timeModify:l()},content:n}),u("Add thread",{forumid:e,content:n}),d({$root:o,forumEl:i,summary:"[WikiForum] Add thread to forum#".concat(e)})}function v(t){var r=t.forumEl,e=t.forumid,n=void 0===e?"1":e,o=t.threadid,i=t.content,c=t.$root,m=r.wikitext;if("1"===o)return p({forumEl:r,forumid:n,content:i});n=Number(n),function t(r,e){var n=r.threadid,o=r.content,i=e.threads;$.each(i,(function(r,e){e.threadid===n?(e.threads=e.threads||[],e.threads.push({meta:{userAuthor:a.wgUserName,userLast:a.wgUserName,timePublish:l(),timeModify:l()},content:o})):e.threads&&t({threadid:n,content:o},e)}))}({threadid:o,content:i},m[--n]),u("Add reply",{forumid:n,threadid:o,content:i}),d({$root:c,forumEl:m,summary:"[WikiForum] Add reply to forum#".concat(n," > thread#").concat(o)})}t.exports={addReply:v,newReply:v,addThread:p,newThread:p,updateThread:function(t){var r=t.forumEl,e=t.forumid,n=void 0===e?"1":e,o=t.threadid,i=t.content,c=t.meta,m=void 0===c?{}:c,f=t.$root,s=r.wikitext;n=Number(n),function t(r,e){var n=r.threadid,o=r.content,i=r.meta,u=void 0===i?{}:i,c=e.threads;$.each(c,(function(r,e){e.threadid===n?(o&&(e.content=o,e.meta.userLast=a.wgUserName,e.meta.timeModify=l()),u&&(e.meta=$.extend({},e.meta,u))):e.threads&&t({threadid:n,content:o},e)}))}({threadid:o,meta:m,content:i},s[--n]),u("Update thread",{forumid:n,threadid:o,content:i}),d({$root:f,forumEl:s,summary:"[WikiForum] Modify forum#".concat(n," > thread#").concat(o)})}}}},r={};function e(n){var o=r[n];if(void 0!==o)return o.exports;var a=r[n]={exports:{}};return t[n](a,a.exports,e),a.exports}!function(){"use strict";var t=e(853),r=e(601).hook;mw.loader.using(["mediawiki.api","mediawiki.util","mediawiki.user"],(function(){var n={parser:e(358),renderer:e(782),updater:e(472)};window.WikiForum=$.extend({},window.WikiForum,n),r("WikiForum").fire(n),t.log("Ready!")}))}()}();
//# sourceMappingURL=core.min.js.map