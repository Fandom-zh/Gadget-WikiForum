/*! For license information please see core.min.js.LICENSE.txt */
!function(){var t={486:function(t,r,e){var n=e(601),o=n.api,a=n.editToken;t.exports=function(t){var r=t.title,e=t.text,n=t.summary;return $.post(o,{format:"json",action:"edit",token:a,title:r,text:e,summary:n})}},406:function(t,r,e){var n=e(601),o=n.api,a=n.conf;t.exports=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:a.wgPageName;return $.get(o,{format:"json",action:"parse",prop:"text|wikitext",disabletoc:1,disableeditsection:1,page:t})}},853:function(t){function r(){for(var t,r=arguments.length,e=new Array(r),n=0;n<r;n++)e[n]=arguments[n];(t=console).info.apply(t,["[WikiForum] [INFO]"].concat(e))}function e(){for(var t,r=arguments.length,e=new Array(r),n=0;n<r;n++)e[n]=arguments[n];(t=console).error.apply(t,["[WikiForum] [ERR]"].concat(e))}t.exports={log:r,info:r,warn:function(){for(var t,r=arguments.length,e=new Array(r),n=0;n<r;n++)e[n]=arguments[n];(t=console).warn.apply(t,["[WikiForum] [WARN]"].concat(e))},error:e,err:e}},601:function(t){t.exports={api:mw.util.wikiScript("api"),conf:mw.config.get(),editToken:mw.user.tokens.get("csrfToken")||mw.user.tokens.get("editToken"),hook:mw.hook,util:mw.util}},358:function(t){function r(t,r){var n=$(t),o=[];return n.hasClass("wiki-forum")||(n=n.find(".wiki-forum")),n.each((function(t,n){o.push({forumid:String(t+1),meta:$.extend({},$(n).data(),{pageName:r}),threads:e(n)})})),o}function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=$(t);r&&(r+="-");var u=[],c=n(i);return $.each(c,(function(t,i){var c={threadid:String(r+(t+1)),content:o(i),meta:a(i)};n(i).length>0&&(c.threads=e(i,c.threadid)),u.push(c)})),u}function n(t){return $(t).find("> .forum-thread")}function o(t){var r=$(t).find("> .forum-content").html()||"";return r=r.trim().replace(/^<!--\s*?start\s+?content\s*?-->/,"").replace(/<!--\s*?end\s+?content\s*?-->$/,"").replace(/^\n/,"").replace(/\n$/,"")}function a(t){return $(t).data()}t.exports={fromApi:function(t){var e=t.parse.title,n=t.parse.wikitext["*"],o=t.parse.text["*"],a=$("<div>"+n+"</div>"),i=$("<div>"+o+"</div>");i.find("> .mw-parser-output").length>0&&(i=i.find("> .mw-parser-output"));var u={wikitext:r(a,e),html:r(i,e)};return window.WikiForum=window.WikiForum||{},window.WikiForum.cache=window.WikiForum.cache||{},window.WikiForum.cache.pages=window.WikiForum.cache.pages||{},window.WikiForum.cache.pages[e]=u,u},fromHtml:function(t){return r($(t))}}},782:function(t,r,e){var n=e(358).fromApi,o=e(406),a=e(601),i=a.hook,u=a.conf,c=e(853),m=c.log,d=c.error;function f(t){var r=t.forumEl,e=t.forumid,n=void 0===e?"1":e,o=t.threadid;n=Number(n);var a=r[--n];o=o.split("-"),$.each(o,(function(t,r){r=Number(r),r--,o[t]=r}));var i=a;return $.each(o,(function(t,r){m("thread",i.threads[r]),i=i.threads[r]})),i}function h(t){var r=t.forumEl,e=t.theme,n=t.$root;m("开始渲染全部论坛");var o=r.html,a=e.allForumsContainer();return o.length<1?e.noForumContainer&&a.append(e.noForumContainer()):$.each(o,(function(t,i){m("递归渲染主题","".concat(t+1,"/").concat(o.length)),a.append(function(t){var r=t.$root,e=t.$container,n=t._forum,o=t.forum,a=t.forumMeta,i=t.forumid,u=t.theme,c=u.forumContainer({meta:a});$.each(o.threads,(function(t,e){c.append(s({$root:r,$container:c,_forum:n,theme:u,thread:e,forumMeta:a,forumid:i}))})),u.afterForum&&c.append(u.afterForum({$root:r,$container:e,_forum:n,forumMeta:a,forumid:i,fn:l}));return c}({$root:n,_forum:r,forumMeta:i.meta,forumid:i.forumid,forum:i,theme:e}),null==e?void 0:e.afterAllForums({$root:n,$container:a,_forum:r,forumMeta:i.meta,forumid:i.forumid,fn:l}))})),a}function s(t){var r=t.$root,e=t.$container,n=t._forum,o=t.theme,a=t.thread,i=t.forumMeta,u=t.forumid,c=a.content,d=a.meta,f=a.threadid;m("渲染贴子",{forumid:u,threadid:f});var h=o.threadContainer({$root:r,$container:e,_forum:n,forumMeta:i,forumid:u,threadid:f,meta:d,content:c,fn:l});return a.threads&&a.threads.length>0&&$.each(a.threads,(function(r,e){t.thread=e,h.append(s(t))})),h}var l={parser:e(358),updater:e(472)};function p(t){var r=t.forumEl,e=t.target,n=void 0===e?"#mw-content-text":e;m("准备渲染到页面，等待主题文件……"),i("WikiForum.theme").fire((function(t){var e=$(n);e.html(h({forumEl:r,theme:t,$root:e})),m("页面渲染完毕"),i("WikiForum.renderer").fire()}))}t.exports={toPage:p,toHtml:function(t){m("渲染并返回 HTML"),mw.hook("WikiForum.theme").fire((function(r){return h({forumEl:t,theme:r})}))},fromPage:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:u.wgPageName,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"#mw-content-text";o(t).then((function(e){m("成功从 API 获取源代码",t),p({forumEl:n(e),target:r})}),(function(r){d("从 API 获取源代码失败",{page:t,err:r})}))},getContent:function(t){return f(t).content},getMeta:function(t){return f(t).meta}}},472:function(t,r,e){var n=e(601).conf,o=e(853),a=o.log,i=o.error,u=e(486);function c(t){for(var r=(t.match(/\{\|/g)||[]).length,e=(t.match(/\n\|\}/g)||[]).length,n=0;n<r-e;n++)t+="\n|}";var o=document.createElement("container");return o.innerHTML=t,t=o.innerHTML}function m(t){var r=t.$root,o=t.forumEl,c=t.summary,m=o[0].meta.pageName,s=function(t){var r="";return t.forEach((function(t){r+=function(t){var r=t.forumid,e=t.meta,n=t.threads,o=f(e),a="";return $.each(n,(function(t,r){a+=d(r)})),"\n\x3c!-- start forum#".concat(r||"latest",' --\x3e\n<div class="wiki-forum" ').concat(o,">\n").concat(a,"\n</div>\n\x3c!-- end forum#").concat(r||"latest"," --\x3e")}(t)})),r="\x3c!--\n - WikiForum Container\n - \n - Total Forums: ".concat(t.length,"\n - Last modiflied: ").concat(h(),"\n - Last user: ").concat(n.wgUserName,"\n -\n - DO NOT EDIT DIRECTLY\n --\x3e\n").concat(r,"\n\n\x3c!-- end WikiForum --\x3e")}(o);u({title:m,text:s,summary:c}).then((function(t){t.error||t.errors?i(t.error||t.errors):(a("更新论坛成功",t),(0,e(782).fromPage)(m,r))}),(function(t){return i(t)}))}function d(t){for(var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,e=t.threadid,n=t.meta,o=t.threads,a=t.content,i=f(n),u="",m=0;m<r;m++)u+="  ";var h="";o&&o.length>0&&$.each(o,(function(t,e){h+=d(e,r+1)}));var s="\n".concat(u,"\x3c!-- start thread#").concat(e||"latest"," --\x3e\n").concat(u,'<ul class="forum-thread" ').concat(i,">\n").concat(u,'  <li class="forum-content">\n\x3c!-- start content --\x3e\n').concat(c(a),"\n\x3c!-- end content --\x3e\n").concat(u,"  </li>").concat(h,"\n").concat(u,"</ul>\n").concat(u,"\x3c!-- end thread#").concat(e||"latest"," --\x3e\n");return s}function f(t){var r=[];return $.each(t,(function(t,e){var n="data-"+t.replace(/(.*)([A-Z])(.*)/g,"$1-$2$3").toLowerCase();r.push("".concat(n,'="').concat(e,'"'))})),r.sort().join(" ")}function h(){return(new Date).toISOString()}function s(t){var r=t.forumEl,e=t.forumid,o=t.content,i=t.$root,u=r.wikitext;e=Number(e),u[--e].threads.push({meta:{userAuthor:n.wgUserName,userLast:n.wgUserName,timePublish:h(),timeModify:h()},content:o}),a("Add thread",{forumid:e,content:o}),m({$root:i,forumEl:u,summary:"[WikiForum] Add thread to forum#".concat(e)})}function l(t){var r=t.forumEl,e=t.forumid,o=void 0===e?"1":e,i=t.threadid,u=t.content,c=t.$root,d=r.wikitext;if("1"===i)return s({forumEl:r,forumid:o,content:u});o=Number(o),function t(r,e){var o=r.threadid,a=r.content,i=e.threads;$.each(i,(function(r,e){e.threadid===o?(e.threads=e.threads||[],e.threads.push({meta:{userAuthor:n.wgUserName,userLast:n.wgUserName,timePublish:h(),timeModify:h()},content:a})):e.threads&&t({threadid:o,content:a},e)}))}({threadid:i,content:u},d[--o]),a("Add reply",{forumid:o,threadid:i,content:u}),m({$root:c,forumEl:d,summary:"[WikiForum] Add reply to forum#".concat(o," > thread#").concat(i)})}t.exports={addReply:l,newReply:l,addThread:s,newThread:s,updateThread:function(t){var r=t.forumEl,e=t.forumid,o=void 0===e?"1":e,i=t.threadid,u=t.content,c=t.meta,d=void 0===c?{}:c,f=t.$root,s=r.wikitext;o=Number(o),function t(r,e){var o=r.threadid,a=r.content,i=r.meta,u=void 0===i?{}:i,c=e.threads;$.each(c,(function(r,e){e.threadid===o?(a&&(e.content=a,e.meta.userLast=n.wgUserName,e.meta.timeModify=h()),u&&(e.meta=$.extend({},e.meta,u))):e.threads&&t({threadid:o,content:a},e)}))}({threadid:i,meta:d,content:u},s[--o]),a("Update thread",{forumid:o,threadid:i,content:u}),m({$root:f,forumEl:s,summary:"[WikiForum] Modify forum#".concat(o," > thread#").concat(i)})}}}},r={};function e(n){var o=r[n];if(void 0!==o)return o.exports;var a=r[n]={exports:{}};return t[n](a,a.exports,e),a.exports}!function(){"use strict";var t=e(853),r=e(601).hook;mw.loader.using(["mediawiki.api","mediawiki.util","mediawiki.user"],(function(){var n={parser:e(358),renderer:e(782),updater:e(472)};window.WikiForum=$.extend({},window.WikiForum,n),r("WikiForum").fire(n),t.log("Ready!")}))}()}();
//# sourceMappingURL=core.min.js.map